---
id: 4.5-sensor-fusion
title: "Sensor Fusion: Kalman Filters and Probabilistic Approaches"
---

## 4.5 Sensor Fusion: Kalman Filters and Probabilistic Approaches

Individual sensors on a humanoid robot have limitations: noise, latency, drift, and susceptibility to environmental conditions. **Sensor fusion** is the process of combining data from multiple sensors to achieve a more accurate, reliable, and comprehensive understanding of the robot's state and environment than any single sensor could provide alone. Probabilistic approaches, particularly Kalman Filters and their extensions, are foundational to robust sensor fusion.

### The Need for Sensor Fusion

*   **Improved Accuracy:** Averaging or combining noisy measurements from multiple sources.
*   **Enhanced Robustness:** Mitigating the failure or limitations of individual sensors.
*   **Comprehensive State Estimation:** Estimating unobservable states by combining different sensor types (e.g., combining IMU with GPS to estimate position without GPS drift).
*   **Redundancy and Fault Tolerance:** Providing alternative data sources in case of sensor failure.

### Kalman Filter

The **Kalman Filter** is an optimal estimation algorithm that uses a series of measurements observed over time, containing noise and other inaccuracies, and produces estimates of unknown variables (e.g., position, velocity, orientation) that tend to be more precise than those based on a single measurement alone. It operates in two main phases:

1.  **Predict:** Estimates the current state and its uncertainty based on the previous state and a system model.
    ```latex
    \hat{\mathbf{x}}_k^- = A \hat{\mathbf{x}}_{k-1} + B \mathbf{u}_{k-1}
    P_k^- = A P_{k-1} A^T + Q
    ```
2.  **Update:** Corrects the predicted state based on new sensor measurements, weighing the prediction and measurement by their respective uncertainties.
    ```latex
    K_k = P_k^- H^T (H P_k^- H^T + R)^{-1}
    \hat{\mathbf{x}}_k = \hat{\mathbf{x}}_k^- + K_k (\mathbf{z}_k - H \hat{\mathbf{x}}_k^-)
    P_k = (I - K_k H) P_k^-
    ```

    *   $\hat{\mathbf{x}}$: State estimate
    *   $P$: Error covariance matrix
    *   $A, B, H$: System, input, and observation matrices
    *   $Q, R$: Process and measurement noise covariances
    *   $K$: Kalman gain
    *   $\mathbf{z}$: Measurement

### Extended Kalman Filter (EKF) and Unscented Kalman Filter (UKF)

For non-linear robot systems (which most humanoids are), the standard Kalman Filter is insufficient. Extensions are used:

*   **Extended Kalman Filter (EKF):** Linearizes the non-linear system and measurement models around the current state estimate. Requires computing Jacobians of these non-linear functions.
*   **Unscented Kalman Filter (UKF):** Uses a deterministic sampling approach (unscented transform) to propagate mean and covariance through non-linear functions, avoiding explicit linearization and Jacobian calculations. Often more accurate than EKF for highly non-linear systems.

### ASCII Diagram: Kalman Filter Cycle

```
+------------------+
|     PREDICT      |
| (System Model)   |
+--------+---------+
         |        ^
         V        |
+--------+---------+
|      UPDATE      |
| (Measurement Model)|
+--------+---------+
```

### Example: Simple 1D Kalman Filter in Python (Conceptual)

This simplified Python example demonstrates a 1D Kalman filter for estimating position and velocity from noisy position measurements.

```python
import numpy as np
import matplotlib.pyplot as plt

def kalman_filter_1d(measurements, initial_state, initial_covariance, process_noise, measurement_noise):
    # State: [position, velocity]
    x = initial_state # Initial state estimate
    P = initial_covariance # Initial estimate covariance

    # State transition matrix (assuming constant velocity model)
    dt = 1.0 # time step
    A = np.array([[
        1, dt],
        [0, 1
    ]])

    # Measurement matrix (we only measure position)
    H = np.array([[
        1, 0
    ]])

    # Process noise covariance
    Q = process_noise

    # Measurement noise covariance
    R = measurement_noise

    estimates = []
    for z in measurements:
        # Predict
        x_predict = A @ x
        P_predict = A @ P @ A.T + Q

        # Update
        K = P_predict @ H.T @ np.linalg.inv(H @ P_predict @ H.T + R)
        x = x_predict + K @ (z - H @ x_predict)
        P = (np.eye(len(x)) - K @ H) @ P_predict

        estimates.append(x[0]) # Store estimated position

    return np.array(estimates)

# Simulate measurements
true_positions = np.linspace(0, 10, 100) + np.sin(np.linspace(0, 10, 100))
noisy_measurements = true_positions + np.random.normal(0, 0.5, 100)

# Kalman filter parameters
initial_x = np.array([0.0, 0.0]) # [initial position, initial velocity]
initial_P = np.array([[
    1.0, 0.0],
    [0.0, 1.0
]])
process_noise = np.array([[
    0.01, 0.0],
    [0.0, 0.01
]])
measurement_noise = np.array([[
    0.25
]])

estimated_positions = kalman_filter_1d(noisy_measurements, initial_x, initial_P, process_noise, measurement_noise)

plt.figure(figsize=(12, 6))
plt.plot(true_positions, label='True Position', color='blue')
plt.scatter(range(len(noisy_measurements)), noisy_measurements, label='Noisy Measurements', color='red', alpha=0.6, s=10)
plt.plot(estimated_positions, label='Kalman Filter Estimate', color='green', linewidth=2)
plt.title("1D Kalman Filter for Position Estimation")
plt.xlabel("Time Step")
plt.ylabel("Position")
plt.legend()
plt.grid(True)
plt.show()

# In ROS, the `robot_localization` package (based on EKF/UKF) is a standard tool
# for fusing data from IMUs, odometry (wheel encoders/visual odometry), GPS, etc.
# It publishes an estimated `nav_msgs/Odometry` or `geometry_msgs/PoseStamped`.
# Example launch file configuration for `robot_localization` would specify input topics.
```

### Multiple Choice Question

Which of the following is a primary advantage of using sensor fusion in humanoid robotics?

a) Eliminates the need for any individual sensors.

b) Reduces the overall cost of the robotic system.

c) Provides a more accurate and reliable estimate of the robot's state and environment.

d) Increases the response time of the robot's control system.

**Answer:** c)

### Short Question

Briefly explain why an Extended Kalman Filter (EKF) or Unscented Kalman Filter (UKF) is often necessary for humanoid robots, as opposed to a standard Kalman Filter.

### Assignment

Research the concept of *Particle Filters* (also known as Sequential Monte Carlo methods). Describe their working principle and discuss a specific scenario in humanoid robotics where a Particle Filter might be preferred over a Kalman Filter for state estimation, explaining the reasons for this preference.
